name: Publicar Reto Diario y Desplegar Web

on:
  schedule:
    # Se ejecuta a las 5:30 AM UTC (7:30 AM en EspaÃ±a), de Lunes a Viernes
    - cron: '30 5 * * 1-5'
  # TambiÃ©n permite ejecutarlo manualmente para pruebas
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  preparar_reto:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Git
        run: |
          git config --global user.name 'Mathgym Publisher Bot'
          git config --global user.email 'actions@github.com'

      - name: Publicar el reto mÃ¡s antiguo del almacÃ©n
        id: publicador
        run: |
          RETO_A_PUBLICAR=$(find almacen_retos -type f -printf '%T+ %p\n' | sort | head -n 1 | cut -d' ' -f2-)
          
          if [ -z "$RETO_A_PUBLICAR" ]; then
            echo "âš ï¸ Â¡AlmacÃ©n de retos vacÃ­o! No hay nada que publicar."
            echo "COMMIT_NEEDED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "âœ… Publicando el reto: $RETO_A_PUBLICAR"
          cp "$RETO_A_PUBLICAR" "reto.json"
          rm "$RETO_A_PUBLICAR"
          echo "COMMIT_NEEDED=true" >> $GITHUB_ENV

      - name: Guardar los cambios (si los hay)
        if: env.COMMIT_NEEDED == 'true'
        run: |
          git add reto.json
          git rm $(git ls-files --deleted)
          git commit -m "ðŸš€ Publicado el reto del dÃ­a $(date +'%Y-%m-%d')"
          git push

  desplegar_web:
    needs: preparar_reto
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
      - name: Configurar GitHub Pages
        uses: actions/configure-pages@v4
      - name: Subir artefactos de la web
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      - name: Desplegar en GitHub Pages
        uses: actions/deploy-pages@v4
